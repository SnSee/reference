
# 操作系统

## 运行时加载动态库:

```cpp
linux: <dlfcn.h>
    # 加载动态库
    void *dlopen(const char *filename, int flag);
    char *dlerror(void);
    # 加载动态库内符号，如加载函数时symbol为函数名，调用函数时需要将函数强转
    void *dlsym(void *handle, const char *symbol);
    # 关闭动态库
    int dlclose(void *handle);
windows: <libloaderapi.h>	
    A只支持ANSI字符串，W支持Unicode字符串
    Ex支持更多参数，后两个参数可传NULL，部分系统中没有非Ex版本
    HMODULE LoadLibraryA(LPCSTR fileName);
    HMODULE LoadLibraryW(LPCSTR fileName);
    HMODULE LoadLibraryExA(LPCSTR filename, HANDLE hFile, DWORD dwFlags);
    HMODULE LoadLibraryExW(LPCSTR filename, HANDLE hFile, DWORD dwFlags);
    FARPROC GetProcAddress(HMODULE hModule, LPCSTR procName);
    编译时链接kernel32.dll
        如: target_link_libraries(${PROJECT_NAME} kernel32}
```

## 内存映射

### 写入文件

```text
注意点：
    open 打开文件时要用读写模式
    mmap 建立映射时也要读写模式
    如果新建文件或者映射长度大于文件长度，需要使用lseek及write设置文件长度，否则写入时崩溃
```

```cpp
#include <sys/mman.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <stdint.h>
#include <exception>

void write() {
    char *file = "/tmp/test.txt";
    int fd = open(file, O_RDWR | O_CREAT);
    if (fd == -1) {
        auto msg = strerror(errno);
        throw std::exception();
    }
    system((std::string("chmod 600 ") + file).c_str());
    size_t len = 4;
    char *mem_head = (char*)mmap(nullptr, len, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);
    if (mem_head == MAP_FAILED) {
        close(fd);
        auto msg = strerror(errno);
        throw std::exception();
    }
    lseek(fd, len - 1, SEEK_SET);
    write(fd, "", 1);

    *((uint32_t*)mem_head) = 1996;

    munmap(mem_head, len);
    close(fd);
}
```

```cpp
void read() {
    char *file = "/tmp/test.txt";
    int fd = open(file, O_RDONLY);
    if (fd == -1) {
        auto msg = strerror(errno);
        throw std::exception();
    }
    size_t len = lseek(fd, 0, SEEK_END);
    char *mem_head = (char*)mmap(nullptr, len, PROT_READ, MAP_SHARED, fd, 0);
    if (mem_head == MAP_FAILED) {
        close(fd);
        auto msg = strerror(errno);
        throw std::exception();
    }

    uint32_t value;
    value = *((uint32_t*)mem_head);

    munmap(mem_head, len);
    close(fd);
}
```
